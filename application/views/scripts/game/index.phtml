<?php
            if ($this->turn['playerId'] == $this->playerId) {
                $div = '<a href="javascript:sendNextTurn()">Next turn</a>';
                $myTurn = 'true';
                $nextArmy = 'Next army';
            } else {
                $div = $this->turn['color'] . ' turn';
                $myTurn = 'false';
                $nextArmy = '';
            }
?>
<script type="text/javascript">

    var colors = <?php echo Zend_Json::encode($this->colors); ?>;
    <?php $this->headScript()->captureStart() ?>
    var fields = <?php echo Zend_Json::encode($this->fields); ?>;
    <?php $this->headScript()->captureEnd() ?>

    var players = <?php echo Zend_Json::encode($this->players); ?>;
    var castles = <?php echo Zend_Json::encode($this->castlesSchema); ?>;
    my.color = '<?php echo $this->color ?>';
    my.playerId = '<?php echo $this->playerId ?>';
    turn.color = '<?php echo $this->turn['color'] ?>';
    turn.playerId = '<?php echo $this->turn['playerId'] ?>';
    turn.myTurn = <?php echo $myTurn ?>;
    var urlMove = '<?php echo $this->url(array('controller' => 'move', 'action' => 'go', 'armyId' => null, 'x' => null, 'y' => null)) ?>';
    var urlNextTurn = '<?php echo $this->url(array('controller' => 'turn', 'action' => 'next')) ?>';
    var urlStartMyTurn = '<?php echo $this->url(array('controller' => 'turn', 'action' => 'start')) ?>';
    var urlFightCastle = '<?php echo $this->url(array('controller' => 'fight', 'action' => 'castle')) ?>';
    var urlFightArmy = '<?php echo $this->url(array('controller' => 'fight', 'action' => 'army')) ?>';
    var urlAddArmy = '<?php echo $this->url(array('controller' => 'gameajax', 'action' => 'addarmy')) ?>';
    var urlGetPlayerArmies = '<?php echo $this->url(array('controller' => 'gameajax', 'action' => 'armies')) ?>';
    var urlSplitArmy = '<?php echo $this->url(array('controller' => 'gameajax', 'action' => 'split')) ?>';
    var urlSetProduction = '<?php echo $this->url(array('controller' => 'production', 'action' => 'set')) ?>';
    $('#nextArmy').click(function() {
        if(lock) {
            return null;
        }
        var reset = true;
        for(i in players[my.color].armies) {
            if(nextArmySelected) {
                nextArmy = i;
                var reset = false;
                break;
            }
            if(!nextArmy) {
                nextArmy = i;
            }
            if(nextArmy == i){
                if(nextArmySelected == false){
                    nextArmySelected = true;
                    unselectArmy();
                    selectArmy(players[my.color].armies[nextArmy]);
                }
            }
        }
        nextArmySelected = false;
        if(reset) {
            nextArmy = null;
        }
    });
    var board = $("#board")
    .mousedown(function(event) {
        if(lock) {
            return null;
        }

        switch (event.which) {
            case 1:
                if(selectedArmy != null) {
                    sendMove(cursorPosition(event.pageX, event.pageY));
                }
                break;
            case 2:
                alert('Middle mouse button pressed');
                break;
            case 3:
                unselectArmy();
                break;
            default:
                alert('You have a strange mouse');
        }
    })
    .mousemove(function(e) {
        if(lock) {
            return null;
        }
        cursorPosition(e.pageX, e.pageY);
    });

    $('#'+my.color+'Color').append('You');
    $('#'+turn.color+'Turn').html('Turn');
    if(turn.myTurn) {
        $('#nextArmy').html('Next army');
        $('#nextTurn').html('Next turn');
    } else {
        $('#nextArmy').html('');
        $('#nextTurn').html('');
    }
    $('#connect').click(function() {
        wsConnect();
    });

    $('#nextTurn').click(function() {
        if(turn.myTurn) {
            sendNextTurn();
            $('#nextTurn').css({
                'text-decoration':'underline',
                'color':'blue'
            });
        }
    });
</script>
